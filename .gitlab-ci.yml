image: docker

variables:
    DOCKER_TLS_CERTDIR: "/certs"

services:
    - docker:dind

before_script:
    - docker pull registry.agilicode.fr/agilicode/php:8.1-fpm

phpunit:
    script:
        - docker run -v $(pwd):/srv/app --rm registry.agilicode.fr/agilicode/app:8.1-fpm composer install
        - docker run -e XDEBUG_MODE=coverage -v $(pwd):/srv/app --rm registry.agilicode.fr/agilicode/app:8.1-fpm vendor/bin/phpunit -c phpunit.xml --coverage-text --coverage-cobertura=coverage.cobertura.xml --log-junit=junit-report.xml tests
    artifacts:
        when: always
        reports:
            junit: junit-report.xml
            coverage_report:
                coverage_format: cobertura
                path: coverage.cobertura.xml
        expire_in: 1 week

sonarqube-check:
    image:
        name: sonarsource/sonar-scanner-cli:latest
        entrypoint: [""]
    variables:
        SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
        GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task
    cache:
        key: "${CI_JOB_NAME}"
        paths:
            - .sonar/cache
    script:
        - sonar-scanner
    allow_failure: true
    rules:
        - if: $CI_COMMIT_BRANCH == 'develop'
